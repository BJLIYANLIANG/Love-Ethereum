# 分布式系统共识算法分析

## 😊分布式系统简介



### 分布式系统模型


想弄明白分布式共识问题，首先要了解分布式系统中的基础模型，我们在设计和思考分布式算法时，首先需要思考的一点就是算法运行的环境是什么，算法运行中需要处理什么样的问题，一般来说从以下三个方面来考虑：

*  分布式系统中节点会发生什么样的故障？最为常用的两种故障模型是**故障-停止（Fail-stop)** 和 **随机故障（Byzantine)** ，在故障-停止模型中当进程发生故障后简单的停止运行，相对的，随机故障又称为拜占庭故障，意指发生故障的进程会像不忠的拜占庭将军一样，产生无法预料的响应结果。故障-停止是随机故障的一种特殊形式，因此，能够容忍随机故障的算法也能够容忍故障-停止。

*  分布式系统的网络传输时延特性是什么样的？ 在分布式系统中，节点间通过传递消息进行通信，按照消息在网络中传递时间是否有上限，可以将分布式系统分为同步模型（Synchronous model)和异步模型（Asynchronous model）， 在同步分布式系统中消息传递时间的上限是已知的，而在异步分布式系统中消息可能在任何时间送达。因此在同步分布式系统中，由于消息传递时间的上限已知，则可以根据超时来检测进程故障（非拜占庭故障），大大简化了分布式算法的设计，但遗憾的是，大部分实际的分布式系统往往是异步的，比如互联网就是异步分布式系统，如果为异步分布式系统中设计分布式算法，必须意识到消息可能延迟任意长的时间到达。

*   分布式系统消息传递的可靠性如何？在分布式系统中传递的消息有可能出现丢失、乱序甚至重复送达的情况，算法是否需要容忍这些情况.网络分区就是一种常见的需要加以考虑的现象.


在整个设计和思考分布式算法的过程中，都要基于同样的系统模型来进行，并对分布式算法的正确性进行证明。通常来讲，一个正确的分布式算法需要满足两条性质：

* Safety：具备Safety性质的算法保证坏的事情绝对不会发生，例如对于满足Safety性质的分布式选主(Leader election)算法，绝对不会出现一个以上进程被选为Leader的情况。

* Liveness：具备Liveness性质的算法保证好的事情终将发生，即算法在有限的时间内可以结束。

综上，一个正确的分布式算法可以在指定的分布式系统模型中保证Safety和Liveness属性。





### 分布式共识（Consensus)

分布式共识问题，简单说，就是在一个或多个节点提议了一个值应当是什么后，使系统中所有节点对这个值达成一致意见。这样的协定问题在分布式系统中很常用，比如说选主（Leader election）问题中所有节点对Leader达成一致；原子组播（Atomic  broadcast）中节点对消息传递（delivery）顺序达成一致。对于这些问题有一些特定的算法，但是，分布式共识问题试图探讨这些问题的一个更一般的形式，如果能够解决分布式共识问题，则以上的问题都可以得以解决。

为了达到共识，每个节点都提出自己的提议（propose），最终通过共识算法，所有正确运行的节点决定（decide）相同的值。

共识算法的正确性要求是在运行中满足以下条件：

* 终止性（Liveness）：所有正确节点最后都能完成决定。

* 协定性（Safety）：所有正确节点决定相同的值。

* 完整性（Integrity）：如果正确的节点都提议同一个值，那么所有正确节点最终决定该值。


如果在一个不出现故障的系统中，很容易可以构造出一个符合要求的共识算法：每个节点都将自己的提议通过可靠组播（Reliable broadcast）发送给其他节点，当节点收到所有成员的提议后，取所有提议中出现最多的值作为最终决定即可。

而如果是在存在故障的异步系统中，共识问题是否有可用的解法呢?

著名的FLP不可能性证明告诉我们：** 没有任何算法可以在存在任何故障的异步系统中确保达到共识 ，正如之前说的，大部分实际的分布式系统都是异步的，FLP不可能性证明阻止了无数分布式系统设计者把时间浪费在寻找一个完美的异步系统共识算法上，而更应该去使用一个不那么完美却有实际意义的解法。


正如FLP不可能性证明所述，不存在算法可以“确保”达到共识，但我们可以设计出有较大概率可以达到共识的算法。绕过不可能性结论的办法是考虑部分同步系统，利用故障屏蔽、故障检测器或随机化手段避开异步系统模型，构造出可接受的共识算法。



### 共识与多副本状态机（Replicated state machines）

分布式系统中对共识问题的直接应用常常是在多副本状态机的场景中出现的。多副本状态机是指多台机器具有完全相同的状态，并且运行有完全相同的确定性状态机。通过使用这样的状态机，可以解决很多分布式系统中的容错问题，因为多副本状态机通常可以容忍⌊N／2⌋进程故障，且所有正常运行的副本都完全一致，所以，可以使用多副本状态机来实现需要避免单点故障的组件。虽然有很多不同的多副本状态机实现，但其基本实现模式是类似的：状态机的每个副本上都保存有完全相同的操作日志，保证所有副本状态机按照相同的顺序执行操作，这样由于状态机是确定性的，则一定会得到相同的状态。

共识算法的作用就是在这样的场景中保证所有副本状态机上的操作日志具有完全相同的顺序，具体来讲: 如果状态机的任何一个副本在本地状态机上执行了一个操作，则绝对不会有别的副本在操作序列相同位置执行一个不同的操作。

而在区块链中,共识算法需要解决的问题是在多个可能会出现随机故障的节点间维护其账本数据的一致性.



## 😊几种经典的共识算法


### Paxos介绍

* Paxos算法是基于消息传递且具有高度容错特性的一致性算法，是目前公认的解决分布式一致性问题最有效的算法之一。


* 在常见的分布式系统中，总会发生诸如机器宕机或网络异常（包括消息的延迟、丢失、重复、乱序，还有网络分区）等情况。Paxos算法需要解决的问题就是如何在一个可能发生上述异常的分布式系统中，快速且正确地在集群内部对某个数据的值达成一致，并且保证不论发生以上任何异常，都不会破坏整个系统的一致性。

* 简单的理解,在分布式系统中,即使出现网络异常以及节点出现机器死机的异常,利用Paxos算法可以保证每个节点整个系统中节点状态的一致性

### Paxos 算法的推理

如果想具体理解Paxos的具体工作过程,可以阅读和参考下面两篇文章:

* [Paxos算法原理与推导](http://www.cnblogs.com/linbingdong/p/6253479.html)
* [Paxo的经典论文](https://github.com/xianfeng92/Love-Ethereum/blob/master/book/paxos-simple.pdf)


### PBFT


### RAFT



## 😊区块链系统的共识算法


### POW


### POS



